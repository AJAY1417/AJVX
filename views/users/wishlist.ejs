<%- include('../layouts/user/header.ejs') %>

<main class="main">
    <div class="page-content d-flex justify-content-center align-items-center" style="height: 100vh;">
        <div class="container text-center">
            <table class="table table-wishlist table-mobile">
                <!-- Your table content -->
                <thead>
                    <tr>
                        <th>Product</th>
                        <th>Price</th>
                        <th>Stock Status</th>
                        <th></th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
                    <% for (let i = 0; i < wishlist.length; i++) { %>
                        <% const product = wishlist[i].productid %>
                        <% for (let j = 0; j < product.length; j++) { %>
                            <% const pro = product[j] %>
                            <tr data-product-id="<%= pro._id %>">
                                <td class="product-col">
                                    <div class="product">
                                        <figure class="product-media">
                                            <a href="#">
                                                <img src="/public/images/products/<%= pro.images[0] %>" alt="Product image">
                                            </a>
                                        </figure>
                
                                        <h3 class="product-title">
                                            <a href="#">
                                                <%= pro.name %>
                                            </a>
                                        </h3><!-- End .product-title -->
                                    </div><!-- End .product -->
                                </td>
                                <td class="price-col">
                                    <% if (pro.discountPrice) { %>
                                        ₹<%= pro.discountPrice %>
                                    <% } else { %>
                                        ₹<%= pro.price %>
                                    <% } %>
                                </td>
                                <td class="stock-col">
                                    <% if (pro.quantity === 0) { %>
                                        <span class="out-of-stock">Out of stock</span>
                                    <% } else { %>
                                        <span class="in-stock">In stock</span>
                                    <% } %>
                                </td>
                                <td class="action-col">
                                    <form onsubmit="addToCart('<%= pro._id %>'); return false;">
                                        <button type="submit" class="btn-product btn-cart"><span>Add to cart</span></button>
                                    </form>
                                </td>
                                <td class="remove-col">
                                    <a href="/deleteWishlistProduct?id=<%= pro.productId %>">
                                        <button class="btn-remove">
                                            <i class="icon-close"></i>
                                        </button>
                                    </a>
                                </td>
                            </tr>
                        <% } %>
                    <% } %>
                </tbody>
            </table>
            <% if (wishlist.length === 0) { %>
            <div style="color: red;">
                <h4>EMPTY! PLEASE ADD SOME PRODUCTS</h4>
                <div class="d-flex justify-content-center"> <!-- Added a flex container to center the animation -->
                    <script src="https://unpkg.com/@dotlottie/player-component@latest/dist/dotlottie-player.mjs" type="module"></script> 
                    <dotlottie-player src="https://lottie.host/486be7a8-1d76-4862-a42c-06346577d30c/nwwfigMRQN.json" background="transparent" speed="1" style="width: 300px; height: 300px;" loop autoplay></dotlottie-player>
                </div>
            </div>
            <% } %>
        </div><!-- End .container -->
    </div><!-- End .page-content -->
</main><!-- End .main -->

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
  async function addToCart(id) {
    console.log("addToCart function called with id: " + id);
    try {
        const response = await $.ajax({
            url: "/addTocart",
            method: "post",
            encoded: true,
            data: {
                id: id
            },
        });

        if (response && response.success) {
            console.log(response);

            await Swal.fire({
                icon: 'success',
                title: 'Item has been added to Cart!',
                showConfirmButton: false,
                timer: 1000
            });

            // Remove the product from the wishlist on the client side
            const wishlistItem = document.querySelector(`[data-product-id="${id}"]`);
            if (wishlistItem) {
                wishlistItem.remove();
            }

            // You need to update the wishlist on the server side. Make an AJAX call to do this.
            // Example: $.ajax({ url: "/updateWishlist", method: "post", data: { productId: id } });

        } else {
            swal("Fail to add");
        }
    } catch (error) {
        console.error("Error in addToCart", error);
        swal("Fail to add");
    }
}

</script>

<%- include('../layouts/user/footer.ejs') %>

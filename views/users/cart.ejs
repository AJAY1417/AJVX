<%- include('../layouts/user/header.ejs') %>

<main class="main">
  <div class="page-header text-center" style="background-image: url('assets/images/page-header-bg.jpg')">
    <div class="container">
      <h1 class="page-title">Shopping Cart<span>Shop</span></h1>
    </div>
  </div>

  <nav aria-label="breadcrumb" class="breadcrumb-nav">
    <div class="container">
      <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="/">Home</a></li>
        <li class="breadcrumb-item"><a href="#">Shopping</a></li>
        <li class="breadcrumb-item active" aria-current="page">Shopping Cart</li>
      </ol>
    </div>
  </nav>

  <div class="page-content" id="Cart">
    <div class="cart">
      <div class="container">
        <div class="row">
          <div class="col-lg-9">
            <table class="table table-cart table-mobile">
              <thead>
                <tr>
                  <th>Product</th>
                  <th>Price</th>
                  <th>Quantity</th>
                  <th>Total</th>
                  <th></th>
                </tr>
              </thead>
              <tbody>
                <% if (cartItems.products && cartItems.products.length > 0) { %>
                  <% for (let i = 0; i < cartItems.products.length; i++) { %>
                    <% const cart = cartItems.products[i]; %>
                    <tr>
                      <td class="product-col">
                        <div class="product">
                          <figure class="product-media">
                            <a href="#">
                              <img src="/public/images/products/<%= cart?.productId?.images[0] %>" alt="Product image" />
                            </a>
                          </figure>
                          <h3 class="product-title">
                            <a href="#"><%= cart?.productId?.name %></a>
                          </h3>
                        </div>
                      </td>
                      <td class="price-col"><%= cart?.productId?.price %></td>
                      <td class="quantity-col">
                        <div class="cart-product-quantity">
                          <div class="input-group">
                            <div class="input-group-prepend">
                              <button class="btn btn-decrement btn-spinner" type="button" data-product-id="<%= cart?.productId?._id %>" onclick="updateCount(-1, '<%= cart?.productId?._id %>')">-</button>
                            </div>
                            <input type="text" class="form-control" id="quantity-<%= cart._id %>" value="<%= cart.quantity %>" readonly />
                            <div class="input-group-append">
                              <button class="btn btn-increment btn-spinner" type="button" data-product-id="<%= cart?.productId?._id %>" onclick="updateCount(1, '<%=cart?.productId?._id%>')">+</button>
                            </div>
                          </div>
                        </div>
                      </td>
                      <td class="total-col" data-product-id="<%= cart._id %>" id="total-<%= cart._id %>"><%= cart.price * cart.quantity %></td>
                      <td class="remove-col">
                        <a href="#" data-product-id="<%= cart?.productId._id %>" onclick="handleUserAction(event)">
                          <button class="btn-remove">
                            <i class="icon-close"></i>
                          </button>
                        </a>
                      </td>
                    </tr>
                  <% } %>
                <% } else { %>
                  <tr>
                    <td colspan="5">No items in the cart.</td>
                  </tr>
                <% } %>
              </tbody>
            </table>
          </div>

          <aside class="col-lg-3">
            <div class="summary summary-cart">
              <h3 class="summary-title">Cart Total</h3>
              <table class="table table-summary">
                <tbody>
                  <tr class="summary-subtotal">
                    <td>Subtotal:</td>
                    <td>$<%= totalSum %></td>
                  </tr>
                </tbody>
              </table>

              <% if (cartItems.products && cartItems.products.length > 0) { %>
                <a href="/checkout" class="btn btn-outline-primary-2 btn-order btn-block">PROCEED TO CHECKOUT</a>
              <% } %>
            </div>

            <a href="/shop" class="btn btn-outline-dark-2 btn-block mb-3">
              <span>CONTINUE SHOPPING</span>
              <i class="icon-refresh"></i>
            </a>
          </aside>
        </div>
      </div>
    </div>
  </div>
</main>

<!-- Your other JavaScript code -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@10"></script>

<!-- Update Quantity Script -->
<script>
  function showErrorAlert(title, text) {
    Swal.fire({
      title: title,
      text: text,
      icon: "error",
      confirmButtonText: "OK",
    });
  }

  function updateCount(val, productId) {
    console.log("UpdateCount function is called ");
    $.ajax({
      method: "post",
      url: "/updateCartQuantity",
      data: JSON.stringify({ id: productId, val: val }),
      contentType: "application/json",
      success: function (response) {
        if (response.result === true) {
          $("#Cart").load("/cart #Cart");
          $("#downCart").load("/cart #downCart");
        } else if (response.result === "stock_exceeded") {
          showErrorAlert("Stock Exceeded", "The product quantity exceeds stock availability.");
        } else if (response.result === false) {
          showErrorAlert("Out of Stock", "This product is currently out of stock.");
        } else if (response.result === "quantity_below_1" && val === -1) {
          showErrorAlert("Invalid Quantity", "The quantity cannot go below 1.");
        }
      },
      error: function (error) {
        console.error("UpdateCount error:", error);
      },
    });
  }
</script>

<!-- Remove Product Script -->
<script>
  function updateCartCount(count) {
    const cartCountElement = document.querySelector('.cart-count');
    if (cartCountElement) {
        cartCountElement.textContent = count;
    }
}

async function handleUserAction(event) {
  event.preventDefault();

  const productId = event.currentTarget.getAttribute("data-product-id");

  const result = await Swal.fire({
    title: "Are you sure?",
    text: "You won't be able to remove this!",
    icon: "warning",
    showCancelButton: true,
    confirmButtonColor: "#3085d6",
    cancelButtonColor: "#d33",
    confirmButtonText: "Yes, remove it!",
  });

  if (result.isConfirmed) {
    try {
      const response = await fetch(`/removeCartProduct?id=${productId}`, {
        method: "GET",
      });

      const data = await response.json();

      if (data.success) {
        // Fetch updated cart count
        const cartCountResponse = await fetch("/cart/count");
        const cartCountData = await cartCountResponse.json();
        const cartCount = cartCountData.totalItems;

        // Update cart count badge
        updateCartCount(cartCount);

        Swal.fire({
          title: "Deleted!",
          text: "Your product has been removed from the cart.",
          icon: "success",
        });
        window.location.href = "/cart";
      } else {
        showErrorAlert("Error", "Unable to remove the product from the cart.");
      }
    } catch (error) {
      console.error("Remove Product error:", error);
      showErrorAlert("Error", "An unexpected error occurred.");
    }
  }
}
</script>

<script>

  async function handleUserAction(event) {
    event.preventDefault();

    const productId = event.currentTarget.getAttribute("data-product-id");

    const result = await Swal.fire({
      title: "Are you sure?",
      text: "You won't be able to remove this!",
      icon: "warning",
      showCancelButton: true,
      confirmButtonColor: "#3085d6",
      cancelButtonColor: "#d33",
      confirmButtonText: "Yes, remove it!",
    });

    if (result.isConfirmed) {
      try {
        const response = await fetch(`/removeCartProduct?id=${productId}`, {
          method: "GET",
        });

        const data = await response.json();

        if (data.success) {
          Swal.fire({
            title: "Deleted!",
            text: "Your product has been removed from the cart.",
            icon: "success",
          });
          window.location.href = "/cart";
        } else {
          showErrorAlert("Error", "Unable to remove the product from the cart.");
        }
      } catch (error) {
        console.error("Remove Product error:", error);
        showErrorAlert("Error", "An unexpected error occurred.");
      }
    }
  }
</script>

<!-- Your other JavaScript code -->

<%- include('../layouts/user/footer.ejs') %>

<%- include('../layouts/admin/header.ejs') %>

<!-- Body Wrapper -->
<div class="page-wrapper" id="main-wrapper" data-layout="vertical" data-navbarbg="skin6" data-sidebartype="full"
  data-sidebar-position="fixed" data-header-position="fixed">
  <!-- Sidebar start -->
  <%- include('../layouts/admin/sideBar.ejs') %>
  <!-- Sidebar end -->
  <!-- Main wrapper -->
  <div class="body-wrapper">
    <!-- Header Start -->
    <%- include('../layouts/admin/headerBar.ejs') %>
    <!-- Header End -->
    <div class="container-fluid">
      <div class="mb-4">
        <a href="/admin/addProduct" class="btn btn-primary">Add Product</a>
      </div>
      <!-- Row 1 -->
      <div class="row">
        <div class="col-lg-12 d-flex align-items-stretch">
          <div class="card w-100">
            <div class="card-body p-5">
              <h5 class="card-title fw-semibold mb-4">PRODUCTS</h5>

              <div class="table-responsive">
                <table class="table text-nowrap mb-0 align-middle w-100" id="user-table">
                  <thead class="text-dark fs-4">
                    <tr>
                      <th class="border-bottom-0">
                        <h6 class="fw-semibold mb-0">sl no</h6>
                      </th>
                      <th class="border-bottom-0">
                        <h6 class="fw-semibold mb-0">Name</h6>
                      </th>
                      <th class="border-bottom-0">
                        <h6 class="fw-semibold mb-0">Category</h6>
                      </th>
                      <th class="border-bottom-0">
                        <h6 class="fw-semibold mb-0">Quantity</h6>
                      </th>
                      <th class="border-bottom-0">
                        <h6 class="fw-semibold mb-0">Description</h6>
                      </th>
                      <th class="border-bottom-0">
                        <h6 class="fw-semibold mb-0">Price</h6>
                      </th>
                      <th class="border-bottom-0">
                        <h6 class="fw-semibold mb-0">Images</h6>
                      </th>
                      <th class="border-bottom-0">
                        <h6 class="fw-semibold mb-0">Action</h6>
                      </th>
                      <th class="border-bottom-0">
                        <h6 class="fw-semibold mb-0">Action</h6>
                      </th>
                      <th class="border-bottom-0">
                        <h6 class="fw-semibold mb-0">Action</h6>
                      </th>
                    </tr>
                  </thead>
                  <tbody>
                    <% for(let i=0;i<products.length;i++){%>
                    <tr>
                      <td class="border-bottom-0"><h6 class="fw-semibold mb-0"><%=i+1%></h6></td>
                      <td class="border-bottom-0">
                        <h6 class="fw-semibold mb-1"><%= products[i].name %></h6>
                      </td>
                      <td class="border-bottom-0">
                        <p class="mb-0 fw-normal"><%= products[i].category.name%></p>
                      </td>
                      <td class="border-bottom-0">
                        <div class="d-flex align-items-center gap-2">
                          <p class="mb-0 fw-normal"><%= products[i].quantity%></p>
                        </div>
                      </td>
                      <td class="border-bottom-0">
                        <p class="mb-0 fw-normal"><%= products[i].description%></p>
                      </td>
                      <td class="border-bottom-0">
                        <h6 class="fw-semibold mb-0 fs-4"><%= products[i].price%></h6>
                      </td>
                      <td class="border-bottom-0">
                        <% for(let j=0;j<products[i].images.length;j++){%>
                        <img src="/public/images/products/<%=products[i].images[j]%>" alt="" width="35" height="35"
                          class="rounded-circle">
                        <%}%>
                      </td>
                      <td class="border-bottom-0">
                        <button type="button" class="btn btn-danger" onclick="handleUserAction('<%= products[i]._id %>', 'block')">Block</button>
                      </td>
                      <td class="border-bottom-0">
                        <button type="button" class="btn btn-success" onclick="handleUserAction('<%= products[i]._id %>', 'unblock')">Unblock</button>
                      </td>
                      <td class="border-bottom-0">
                        <a href="/admin/editProduct/<%= products[i]._id %>" class="btn btn-primary">Edit</a>
                      </td>
                    </tr>
                    <% } %>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@10"></script>

  <script>
    function handleUserAction(productId, actionType) {
      Swal.fire({
        title: "Are you sure?",
        text: "You won't be able to revert this!",
        icon: "warning",
        showCancelButton: true,
        confirmButtonColor: "#3085d6",
        cancelButtonColor: "#d33",
        confirmButtonText: "Yes, proceed!"
      }).then((result) => {
        if (result.isConfirmed) {
          Swal.fire({
            title: "Success!",
            text: "Product has been " + actionType + "ed.",
            icon: "success"
          }).then(() => {
            performUserAction(productId, actionType);
          });
        }
      });
    }

    function performUserAction(productId, actionType) {
      var url = "/admin/block-product?id=" + productId;

      fetch(url, {
        method: 'GET',
        headers: {
          'Content-Type': 'application/json'
        },
      })
      .then(response => {
        if (!response.ok) {
          throw new Error('Network response was not ok');
        }
        location.reload();
      })
      .then(data => {
        console.log('Success:', data);
        location.reload();
      })
      .catch(error => {
        console.error('Error:', error);
        location.reload();
      });
    }
  </script>

  <%- include('../layouts/admin/footer.ejs') %>
